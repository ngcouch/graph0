<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">

    <script type="text/javascript" src="jsPsych/jspsych.js"></script>
    <script type="text/javascript" src="jsPsych/plugins/jspsych-html-keyboard-response.js"></script>
    <script type="text/javascript" src="jsPsych/plugins/jspsych-image-keyboard-response.js"></script>
    <script type="text/javascript" src="jsPsych/plugins/jspsych-survey-text.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript" src="jsPsych/plugins/jspsych-html-slider-response.js"></script>
    <link href="jsPsych/css/jspsych.css" rel="stylesheet" type="text/css"/>

  </head>
  <body>
  </body>

  <script>

    var ID = window.prompt("Enter your participant ID:")

    /*
    while (!Object.keys(conditions).includes(ID)) {

	var ID = window.prompt("ID not found. Please check again, or contact the experimenter.")

    }
    */

    // Create a function that takes an ordered pair of strings A, B and return a list containing
    // two jsPsych trials. The first trial probes the edge between the strings, and the second
    // provides feedback on the participant's response.

    function trial_pair(A, B, relation = "causes", present = true, randomize=false) {

	var trials = []

	
	var trial_stim = "<p>" + A + " " + relation + " " + B + "</p>"

	var stim_trial = {type: "html-keyboard-response",
		      stimulus: trial_stim,
		      choices: [70, 74],
		      data: {present: present},
			  on_finish: function(data) {

			  if ((present)) {

			      if (data.key_press==70) {
				  data.correct = true;
			      }
			      else {
				  data.correct = false;
			      }
			      
			  }
			  else {

			      if (data.key_press==74) {
				  data.correct = true;
			      }
			      else {
				  data.correct = false;
			      }
			  }
		      }
		     }

	var feedback_trial = {type: "html-keyboard-response",
			      stimulus:function() {
				  var last_trial = jsPsych.data.get().last(1).values()[0].correct;
				  console.log(last_trial)
				  if (last_trial) {
				      return  trial_stim + "<p><big>Correct!</big></p>"
				  }
				  else {
				      return  trial_stim + "<p><big>Incorrect!</big></p>"
				  }
			      },
			      response_ends_trial: function() {
				  var last_trial = jsPsych.data.get().last(1).values()[0].correct;
				  if (last_trial) {
				      return 500
				  }
				  else {
				      return 1000
				  }
			      }
			     }
			      	
	return [stim_trial, feedback_trial]

    }

    // create the network structure

    var network = [["A", "B", true, "causes"],
		   ["B", "C", true, "causes"],
		   ["A", "B", true, "prevents"]]

    network = jsPsych.randomization.shuffle(network)
    
    // Structure and assemble the experiment.
    
    var timeline = []

    var welcome = {type: "html-keyboard-response",
		   stimulus: "Welcome to the experiment, and thank you for your time! Press any key to continue."
		  };
    timeline.push(welcome)

    var instructions = {type: "html-keyboard-response",
			stimulus: "<p style='text-align:left;max-width:800px;'>In this experiment, you will be pairs of items and will be asked to decide if they go together or not. If you decide they go together, press <big>F</big>. If they do not, press <big>J</big>. After your guess, you will be told if you are correct. You will repeat this process multiple times.</p> <p>Press spacebar to continue.</p>",
			choices: [32]
		       };

    timeline.push(instructions)

    // create and push the network trials
    var trials_array = []

    // First, loop over the desired number of blocks, constructing a random order of trials
    // for each block.

    var block = 0
    var block_num = 5

    while (block < block_num) {
    
	   var index = 0
	   var block_array = []
    
	   while (index < network.length) {

	       block_array.push(trial_pair(network[index][0],
					   network[index][1],
					   relation = network[index][3],
					   present = network[index][2]))
	
	       index +=1

	   }

	block_array = jsPsych.randomization.shuffle(block_array)

	index = 0

	while (index < block_array.length) {

	    trials_array.push(block_array[index][0])
	    trials_array.push(block_array[index][1])

	}

	block += 1
    }
			 
    jsPsych.init({
	timeline: timeline,
	on_finish: function() {
	    $.ajax({
		type: "POST",
		url: "/experiment-data",
		data: jsPsych.data.get().json(),
		contentType: "application/json"
	    })
		.done(function() {
		    alert("Thank you!")
		})
		.fail(function() {
		    alert("A problem occurred while writing to the database. Please contact the researcher for more information.")
		})
	}
    })

    </script>
</html>
