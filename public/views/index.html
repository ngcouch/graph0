<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">

    <script type="text/javascript" src="jsPsych/jspsych.js"></script>
    <script type="text/javascript" src="jsPsych/plugins/jspsych-html-keyboard-response.js"></script>
    <script type="text/javascript" src="jsPsych/plugins/jspsych-image-keyboard-response.js"></script>
    <script type="text/javascript" src="jsPsych/plugins/jspsych-survey-text.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript" src="jsPsych/plugins/jspsych-html-slider-response.js"></script>
    <script type="text/javascript" src="experiment-data/functions.js"></script>
    <script type="text/javascript" src="experiment-data/networks.js"></script>
    <script type="text/javascript" src="experiment-data/conditions.js"></script>
    <link href="jsPsych/css/jspsych.css" rel="stylesheet" type="text/css"/>

  </head>
  <body>
  </body>

  <script>

    var ID = window.prompt("Enter your participant ID:")

    
    while (!Object.keys(conditions).includes(ID)) {

	var ID = window.prompt("ID not found. Please check again, or contact the experimenter.")

    }

    var condition = conditions[ID]
		       

    // Structure and assemble the experiment.
    
    var timeline = []

    var welcome = {type: "html-keyboard-response",
		   stimulus: "Welcome to the experiment, and thank you for your time! Press any key to continue."
		  };
    timeline.push(welcome)

    // TODO: Change instructions page depending on the condition
    var learning_instructions = {type: "html-keyboard-response",
			stimulus: "<p style='text-align:left;max-width:800px;'>These are the instructions. Press space to continue.</p>",
			choices: [32]
				};

    var test_instructions = {type: "html-keyboard-response",
			     stimulus: "<p>These are the instructions for the test trials. Press space to continue.</p>",
			     choices: [32]
			    };

    timeline.push(instructions)
			     
    // Create random label assignments
    var letters1 = jsPsych.randomization.shuffle(["A", "B", "C", "D", "E", "F", "G"])
    var letters2 = jsPsych.randomization.shuffle(["H", "I", "J", "K", "L", "M", "N"])
    var assign1  =  {"A": letters1[0],
		     "B": letters1[1],
		     "C": letters1[2],
		     "D": letters1[3],
		     "E": letters1[4],
		     "F": letters1[5],
		     "G": letters1[6]}
    var assign2  = {"H": lettersR[0],
		    "I": lettersR[1],
		    "J": lettersR[2],
		    "K": lettersR[3],
		    "L": lettersR[4],
		    "M": lettersR[5],
		    "N": lettersR[6]}
    
    var assignments = [assign1, assign2]
    
    
    // Randomize order of networks
    var networks = [ME_network, MC_network]
    networks = jsPsych.randomization.shuffle(networks)

    // For each network, create the trials and blocks
    // The result is an array with two elements, both arrays of trial pairs.
    trials = []
    blocks = 5 // The number of blocks to run
    for(n = 0; n < networks.length; n++) {

    // Create instructions page
    trials.push(learning_instructions)

    // Create blocks of training trials
    for (b = 0; b < blocks; b++) {

	// Within each block, create a random list of trials teaching the 
	var block_trials = []
	for(i=0; i < networks[n].props.length; i++) {

	    var first = assignments[n][networks[n].props[i][0]]
	    var second = assignments[n][networks[n].props[i][1]]
	    var correct = networks[n].props[i][2]
	    var trials = trial_pair(first, second, correct, b, n, networks[n].name, true)
	    block_trials.push(trials)

	}

	// randomize the order of the trials within a block
	block_trials = jsPsych.randomization.shuffle(block_trials)
	// append to the network 
	trials.push(block_trials)

    }

    // Create distractor task

    var distractor = {type: "html-keyboard-response",
		      stimulus: "<p>This is a distractor task. Please wait 5 minutes, and press spacebar when ready to continue.</p>",
		      choices: [32]}

    trials.push(distractor)
    trials.push(test_instructions)
    // Create test trials
    
    test_blocks = 2
    for (b=0; b < test_blocks; b++) {
	
	var block_trials = []
	for(i=0; i < networks[n].props.length; i++) {
	    
	    var first = assignments[n][networks[n].props[i][0]]
	    var second = assignments[n][networks[n].props[i][1]]
	    var correct = networks[n].props[i][2]
	    var trials = trial_pair(first, second, correct, "test", n, networks[n].name, false)
	    block_trials.push(trials)
	    
	}
	
	block_trials = jsPsych.randomize.shuffle(block_trials)
	trials.push(block_trials)
    }
    
}
    
    
    trials = trials.flat(4)
  

			 
    jsPsych.init({
	timeline: timeline,
	on_finish: function() {
	    $.ajax({
		type: "POST",
		url: "/experiment-data",
		data: jsPsych.data.get().json(),
		contentType: "application/json"
	    })
		.done(function() {
		    alert("Thank you!")
		})
		.fail(function() {
		    alert("A problem occurred while writing to the database. Please contact the researcher for more information.")
		})
	}
    })

    </script>
</html>
